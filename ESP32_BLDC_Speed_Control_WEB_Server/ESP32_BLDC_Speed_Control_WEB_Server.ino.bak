// ESP32_BLDC_Speed_Control_WEB_Server.ino

#include <WiFi.h>
#include <WebServer.h>
#include <Adafruit_NeoPixel.h>
#include <Adafruit_MCP4725.h>

/* ========= USER CONFIG ========= */
const char* ssid     = "ASUS_98_2G";
const char* password = "LiDoDa#959285$";

/* ================= GLOBAL PARAMETERS ================= */
int16_t speed = 0;                 // 0â€“1023
bool enableMotor = false;           // default false
bool direction = true;              // true = forward

/* ================= GPIO ================= */
constexpr uint8_t PIN_ENABLE    = 48;
constexpr uint8_t PIN_DIRECTION = 47;

/* ================= OBJECTS ================= */
WebServer server(80);
Adafruit_MCP4725 dac;

/* ================= TIMING ================= */
unsigned long lastPrint = 0;

/* ================= HTML PAGE ================= */
String makeHTML()
{
  IPAddress ip = WiFi.localIP();

  String html = R"rawliteral(
<!DOCTYPE html>
<html>
<head>
  <title>Speed Web Server</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<h1>Speed Web Server</h1>

<form action="/" method="get">

<label>IP Address:</label><br>
<input type="text" value="%IP%" readonly><br><br>

<label>Enable:</label><br>
<input type="radio" name="Enable" value="1" %EN1% onchange="this.form.Speed.value=0; this.form.submit();"> True<br>
<input type="radio" name="Enable" value="0" %EN0% onchange="this.form.Speed.value=0; this.form.submit();"> False<br><br>

<label>Speed:</label><br>
<input type="number" name="Speed" min="0" max="1023" value="%SPD%">
<br>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)+1;">+1</button>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)-1;">-1</button>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)+10;">+10</button>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)-10;">-10</button>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)+100;">+100</button>
<button type="submit" onclick="this.form.Speed.value=parseInt(this.form.Speed.value)-100;">-100</button>
<br><br>

<label>Direction:</label><br>
<input type="radio" name="Direction" value="1" %DIR1% onchange="this.form.Speed.value=0; this.form.submit();"> Forward<br>
<input type="radio" name="Direction" value="0" %DIR0% onchange="this.form.Speed.value=0; this.form.submit();"> Reverse<br>

</form>
</body>
</html>
)rawliteral";

  html.replace("%IP%", ip.toString());
  html.replace("%SPD%", String(speed));
  html.replace("%EN1%", enableMotor ? "checked" : "");
  html.replace("%EN0%", !enableMotor ? "checked" : "");
  html.replace("%DIR1%", direction ? "checked" : "");
  html.replace("%DIR0%", !direction ? "checked" : "");

  return html;
}

/* ================= HTTP HANDLER ================= */
void handleRoot()
{
  bool changed = false;

  if (server.hasArg("Enable")) {
    bool newEnable = server.arg("Enable").toInt();
    if (newEnable != enableMotor) {
      enableMotor = newEnable;
      speed = 0;
      changed = true;
    }
  }

  if (server.hasArg("Direction")) {
    bool newDir = server.arg("Direction").toInt();
    if (newDir != direction) {
      direction = newDir;
      speed = 0;
      changed = true;
    }
  }

  if (server.hasArg("Speed")) {
    int s = server.arg("Speed").toInt();
    speed = constrain(s, 0, 1023);
    changed = true;
  }

  /* Apply hardware */
  digitalWrite(PIN_ENABLE, enableMotor ? HIGH : LOW);
  digitalWrite(PIN_DIRECTION, direction ? HIGH : LOW);

  if (enableMotor) {
    dac.setVoltage(speed << 2, false);  // scale 10-bit to 12-bit
  } else {
    dac.setVoltage(0, false);
  }

  server.send(200, "text/html", makeHTML());
}

/* ================= SETUP ================= */
void setup()
{
  Serial.begin(115200);

  pinMode(PIN_ENABLE, OUTPUT);
  pinMode(PIN_DIRECTION, OUTPUT);

  digitalWrite(PIN_ENABLE, LOW);
  digitalWrite(PIN_DIRECTION, HIGH);

  Wire.begin();
  dac.begin(0x60);

  WiFi.begin(ssid, password);
  Serial.print("Connecting");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println();
  Serial.print("WebServer IP: ");
  Serial.println(WiFi.localIP());

  server.on("/", handleRoot);
  server.begin();

  Serial.println("HTTP server started");
}

/* ================= LOOP ================= */
void loop()
{
  server.handleClient();

  if (millis() - lastPrint >= 1000) {
    lastPrint = millis();
    Serial.print("Enable=");
    Serial.print(enableMotor);
    Serial.print(" | Speed=");
    Serial.print(speed);
    Serial.print(" | Direction=");
    Serial.println(direction);
  }
}
